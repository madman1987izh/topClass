{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <h2>üéØ –£—á–∞—Å—Ç–∏–µ –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</h2>
    <div class="event-info card">
        <h3>{{ event.name }}</h3>
        <p><strong>–¢–∏–ø:</strong> {{ event.get_type_display() }}</p>
        <p><strong>–ë–∞–ª–ª—ã –¥–ª—è –∫–ª–∞—Å—Å–∞:</strong>
            {% if event.event_type in ['class', 'both'] %}
                2 –±–∞–ª–ª–∞ –∑–∞ —É—á–∞—Å—Ç–∏–µ –∫–ª–∞—Å—Å–∞ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
            {% else %}
                0 –±–∞–ª–ª–æ–≤
            {% endif %}
        </p>
        <p><strong>–õ–∏—á–Ω—ã–µ –±–∞–ª–ª—ã:</strong>
            {% if event.event_type in ['student', 'both'] %}
                —É—á–∞—Å—Ç–∏–µ - 1 –±–∞–ª–ª, 4 –º–µ—Å—Ç–æ - 2 –±–∞–ª–ª–∞, 3 –º–µ—Å—Ç–æ - 3 –±–∞–ª–ª–∞, 2 –º–µ—Å—Ç–æ - 4 –±–∞–ª–ª–∞, 1 –º–µ—Å—Ç–æ - 5 –±–∞–ª–ª–æ–≤
            {% else %}
                0 –±–∞–ª–ª–æ–≤
            {% endif %}
        </p>
    </div>

    <form method="POST" class="auth-form">
        {% if current_user.role and current_user.role in ['admin', 'teacher'] %}

        {% if current_user.role == 'admin' and not managed_class %}
        <div class="form-group">
            <label for="class_id">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label>
            <select id="class_id" name="class_id" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>
                {% for class in classes %}
                <option value="{{ class.id }}">{{ class.grade }}{{ class.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="all_students" name="all_students">
                <label for="all_students">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö —É—á–µ–Ω–∏–∫–æ–≤
                    {% if managed_class %}
                        {{ managed_class.grade }}{{ managed_class.name }}
                    {% else %}
                        –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
                    {% endif %}
                    –∫–ª–∞—Å—Å–∞
                </label>
            </div>
            <small>–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —ç—Ç–æ–π –æ–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —É—á–µ–Ω–∏–∫–∏ –∫–ª–∞—Å—Å–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –º–µ—Å—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∏–∂–µ.</small>
        </div>

        <div class="form-group" id="students-selection">
            <label for="student_ids">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤:</label>
            <select id="student_ids" name="student_ids" multiple style="height: 200px;">
                {% for student in students %}
                <option value="{{ student.id }}">
                    {{ student.full_name }} ({{ student.school_class.grade }}{{ student.school_class.name }})
                </option>
                {% endfor %}
            </select>
            <small>–î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—á–µ–Ω–∏–∫–æ–≤ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl (Cmd –Ω–∞ Mac). –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –æ–ø—Ü–∏–∏ "–≤—Å–µ —É—á–µ–Ω–∏–∫–∏".</small>
        </div>

        {% if students %}
        <div class="form-group">
            <label>–ú–µ—Å—Ç–∞ –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤:</label>
            <div class="places-grid">
                {% for student in students %}
                <div class="place-selection">
                    <label for="place_{{ student.id }}">{{ student.full_name }}:</label>
                    <select id="place_{{ student.id }}" name="place_{{ student.id }}">
                        <option value="not_participated">‚ùå –ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª</option>
                        <option value="" selected>üéØ –£—á–∞—Å—Ç–∏–µ (1 –±–∞–ª–ª)</option>
                        <option value="4">4 –º–µ—Å—Ç–æ (2 –±–∞–ª–ª–∞)</option>
                        <option value="3">ü•â 3 –º–µ—Å—Ç–æ (3 –±–∞–ª–ª–∞)</option>
                        <option value="2">ü•à 2 –º–µ—Å—Ç–æ (4 –±–∞–ª–ª–∞)</option>
                        <option value="1">ü•á 1 –º–µ—Å—Ç–æ (5 –±–∞–ª–ª–æ–≤)</option>
                    </select>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="participants_count">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ç –∫–ª–∞—Å—Å–∞:</label>
            <input type="number" id="participants_count" name="participants_count" value="{{ students|length if students else 1 }}" min="1" required>
        </div>

        {% else %}
        <input type="hidden" name="student_ids" value="{{ current_user.id }}">
        <input type="hidden" name="participants_count" value="1">

        <div class="form-group">
            <label for="place">–í–∞—à–µ –º–µ—Å—Ç–æ:</label>
            <select id="place" name="place">
                <option value="" selected>üéØ –£—á–∞—Å—Ç–∏–µ (1 –±–∞–ª–ª)</option>
                <option value="4">4 –º–µ—Å—Ç–æ (2 –±–∞–ª–ª–∞)</option>
                <option value="3">ü•â 3 –º–µ—Å—Ç–æ (3 –±–∞–ª–ª–∞)</option>
                <option value="2">ü•à 2 –º–µ—Å—Ç–æ (4 –±–∞–ª–ª–∞)</option>
                <option value="1">ü•á 1 –º–µ—Å—Ç–æ (5 –±–∞–ª–ª–æ–≤)</option>
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="news_link">–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–æ–≤–æ—Å—Ç—å –∏–ª–∏ –æ—Ç—á–µ—Ç:</label>
            <input type="url" id="news_link" name="news_link" placeholder="https://...">
        </div>

        <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ —É—á–∞—Å—Ç–∏—è –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:</label>
            <textarea id="description" name="description" rows="4" required placeholder="–û–ø–∏—à–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."></textarea>
        </div>

        <div class="form-group">
            <label for="media_files">–°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</label>
            <textarea id="media_files" name="media_files" rows="3" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é"></textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn">
                {% if current_user.role and current_user.role in ['admin', 'teacher'] %}üéØ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —É—á–∞—Å—Ç–∏–µ{% else %}üì® –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —É—á–∞—Å—Ç–∏–µ{% endif %}
            </button>
            <a href="{{ url_for('events') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

{% if current_user.role and current_user.role in ['admin', 'teacher'] %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const allStudentsCheckbox = document.getElementById('all_students');
    const studentsSelection = document.getElementById('students-selection');
    const classSelect = document.getElementById('class_id');
    const studentSelect = document.getElementById('student_ids');

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è "–≤—Å–µ —É—á–µ–Ω–∏–∫–∏"
    if (allStudentsCheckbox) {
        allStudentsCheckbox.addEventListener('change', function() {
            if (this.checked) {
                if (studentsSelection) studentsSelection.style.display = 'none';
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º "–£—á–∞—Å—Ç–∏–µ" –¥–ª—è –≤—Å–µ—Ö —É—á–µ–Ω–∏–∫–æ–≤
                document.querySelectorAll('select[name^="place_"]').forEach(select => {
                    select.value = ''; // –£—á–∞—Å—Ç–∏–µ (1 –±–∞–ª–ª)
                });
            } else {
                if (studentsSelection) studentsSelection.style.display = 'block';
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–±–æ—Ä—ã –º–µ—Å—Ç –Ω–∞ "–ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª"
                document.querySelectorAll('select[name^="place_"]').forEach(select => {
                    select.value = 'not_participated';
                });
            }
        });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –º–µ—Å—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤
    if (studentSelect) {
        studentSelect.addEventListener('change', function() {
            const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);

            // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–±–æ—Ä—ã –º–µ—Å—Ç –Ω–∞ "–ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª"
            document.querySelectorAll('select[name^="place_"]').forEach(select => {
                select.value = 'not_participated';
            });

            // –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–£—á–∞—Å—Ç–∏–µ"
            selectedOptions.forEach(studentId => {
                const placeSelect = document.getElementById('place_' + studentId);
                if (placeSelect) {
                    placeSelect.value = ''; // –£—á–∞—Å—Ç–∏–µ (1 –±–∞–ª–ª)
                }
            });
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
    if (classSelect) {
        classSelect.addEventListener('change', function() {
            if (this.value) {
                const participantsCount = document.getElementById('participants_count');
                participantsCount.value = 25; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            }
        });
    }
});
</script>
{% endif %}

<style>
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
}

.places-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid var(--gray-light);
    border-radius: var(--border-radius-sm);
}

.place-selection {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 10px;
    background: var(--light);
    border-radius: var(--border-radius-sm);
}

.place-selection label {
    font-weight: 600;
    font-size: 0.9rem;
}

.place-selection select {
    width: 100%;
}
</style>
{% endblock %}